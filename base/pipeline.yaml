apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: pipeline-nextapp
spec:
  params:
    - name: app-name
      type: string
      description: Application name
    - name: source-repo
      type: string
      description: Source code repository
    - name: source-repo-branch
      type: string
      description: Source code repository branch or revision
    - name: image-registry
      type: string
      description: Docker image repository
    - name: GIT_CONFIG_REPO
      type: string
    - name: GIT_USER_NAME
      type: string
    - name: GIT_USER_EMAIL
      type: string
    - name: test-value
  workspaces:
    - name: pipeline-shared-data
    - name: github-credentials
  tasks:
    - name: clone-repository
      params:
        - name: url
          value: "$(params.source-repo)"
        - name: revision
          value: "$(params.source-repo-branch)"
        - name: test-value
          value: "$(params.source-test-value)"
      taskRef:
        name: git-clone
      workspaces:
        - name: output
          workspace: pipeline-shared-data
    - name: print-readme
      runAfter:
        - clone-repository
      taskRef:
        name: print-readme
      workspaces:
        - name: dir-with-readme
          workspace: pipeline-shared-data
    - name: run-tests
      params:
        - name: ARGS
          value:
            - install-ci-test
      runAfter:
        - print-readme
      taskRef:
        name: npm
      workspaces:
        - name: source
          workspace: pipeline-shared-data
    - name: create-image
      params:
        - name: IMAGE
          value: "$(params.image-registry):$(tasks.clone-repository.results.commit)"
        - name: TLSVERIFY
          value: "false"
        - name: STORAGE_DRIVER
          value: vfs
      runAfter:
        - run-tests
      taskRef:
        name: buildah
      workspaces:
        - name: source
          workspace: pipeline-shared-data

    - name: fetch-config-repository
      taskRef:
        name: git-clone
      runAfter:
        - create-image
      workspaces:
        - name: output
          workspace: pipeline-shared-data
      params:
        - name: url
          value: $(params.GIT_CONFIG_REPO)
        - name: revision
          value: main
        - name: deleteExisting
          value: "true"
    - name: update-manifests
      taskRef:
        name: openshift-client
      runAfter:
        - fetch-config-repository
      workspaces:
        - name: manifest-dir
          workspace: pipeline-shared-data
      params:
      - name: SCRIPT
        value: |
          oc patch --type merge --local -o yaml -f /workspace/manifest-dir/base/kustomization.yaml \
            -p "images:
                  - name: image-name-placeholder
                    newName: $(params.image-registry):$(tasks.clone-repository.results.commit)" \
            > kustomization.yaml
            mv kustomization.yaml /workspace/manifest-dir/base/kustomization.yaml
          echo 'Patched kustomization.yaml'

    - name: commit-push
      taskRef:
        name: git-cli
      runAfter:
        - update-manifests
      workspaces:
        - name: source
          workspace: pipeline-shared-data
        - name: ssh-directory
          workspace: github-credentials
      params:
      - name: GIT_USER_NAME
        value: $(params.GIT_USER_NAME)
      - name: GIT_USER_EMAIL
        value: $(params.GIT_USER_EMAIL)
      - name: GIT_SCRIPT
        value: |
          cp /root/.ssh/ssh-directory/ssh-privatekey /root/.ssh/id_rsa
          ssh-keyscan -t rsa github.com > /root/.ssh/known_hosts
          cd /workspace/source
          git checkout main
          git add base/kustomization.yaml
          git commit -m "Container image update"
          git push
